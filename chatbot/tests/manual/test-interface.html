<!DOCTYPE html>
<html>
<head>
  <title>AI Education Chatbot Tester</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f7f9fc;
      color: #333;
    }
    h1 {
      color: #1a73e8;
      margin-bottom: 30px;
      text-align: center;
    }
    .chat-container {
      display: flex;
      flex-direction: column;
      height: 75vh;
    }
    .chat {
      flex-grow: 1;
      border: 1px solid #ddd;
      border-radius: 8px;
      background-color: white;
      height: 100%;
      overflow-y: scroll;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .controls {
      display: flex;
      gap: 12px;
    }
    select, button {
      padding: 10px 16px;
      border-radius: 6px;
      border: 1px solid #ddd;
      background-color: white;
      font-size: 14px;
    }
    button {
      background-color: #1a73e8;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 500;
      transition: background-color 0.2s;
    }
    button:hover {
      background-color: #0d64d8;
    }
    input {
      flex-grow: 1;
      padding: 12px 16px;
      border-radius: 6px;
      border: 1px solid #ddd;
      font-size: 14px;
    }
    .user, .bot, .system {
      margin-bottom: 12px;
      padding: 12px 16px;
      border-radius: 8px;
      max-width: 80%;
    }
    .user {
      background-color: #e2f2ff;
      align-self: flex-end;
      margin-left: auto;
    }
    .bot {
      background-color: #f0f2f5;
      align-self: flex-start;
    }
    .system {
      background-color: #ffe8e8;
      color: #d32f2f;
      align-self: center;
      text-align: center;
    }
    .suggestions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 12px 0;
    }
    .suggestions button {
      background-color: #f0f2f5;
      color: #1a73e8;
      font-size: 12px;
      padding: 6px 12px;
    }
    .suggestions button:hover {
      background-color: #e2f2ff;
    }
    .thinking {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #666;
      font-style: italic;
    }
    .dots {
      display: flex;
      gap: 4px;
    }
    .dots span {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: #999;
      animation: pulse 1.5s infinite;
    }
    .dots span:nth-child(2) {
      animation-delay: 0.2s;
    }
    .dots span:nth-child(3) {
      animation-delay: 0.4s;
    }
    @keyframes pulse {
      0%, 100% { opacity: 0.4; }
      50% { opacity: 1; }
    }
    .citation {
      font-size: 12px;
      color: #666;
      margin-top: 8px;
      font-style: italic;
    }
  </style>
</head>
<body>
  <h1>AI Education Chatbot Test Interface</h1>
  <div class="chat-container">
    <div class="chat" id="chat"></div>
    <div class="controls">
      <select id="proficiency">
        <option value="Beginner">Beginner</option>
        <option value="Intermediate" selected>Intermediate</option>
        <option value="Expert">Expert</option>
      </select>
      <input type="text" id="message" placeholder="Type your question about AI concepts...">
      <button id="sendBtn" onclick="sendMessage()">Send</button>
      <button id="clearBtn" onclick="clearChat()">Clear</button>
    </div>
  </div>
  
  <script>
    // DOM elements
    const chat = document.getElementById('chat');
    const messageInput = document.getElementById('message');
    const proficiencySelect = document.getElementById('proficiency');
    const sendBtn = document.getElementById('sendBtn');
    
    // State
    let conversationHistory = [];
    let conversationSummary = '';
    let thinkingIndicator = null;
    
    // API endpoint
    const API_URL = 'http://localhost:3000/api/chat';
    
    // Initial welcome message
    window.onload = function() {
      addMessage('bot', 'Welcome to the AI Education Chatbot! I can answer questions about AI concepts from the course. What would you like to know?');
    };
    
    // Handle Enter key in input
    messageInput.addEventListener('keyup', function(event) {
      if (event.key === 'Enter') {
        sendMessage();
      }
    });
    
    // Send message function
    async function sendMessage() {
      const text = messageInput.value.trim();
      if (!text) return;
      
      // Disable input while processing
      messageInput.value = '';
      messageInput.disabled = true;
      sendBtn.disabled = true;
      
      // Add user message to chat
      addMessage('user', text);
      
      // Show thinking indicator
      showThinking();
      
      // Call API
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: text,
            conversationHistory: conversationHistory,
            proficiencyLevel: proficiencySelect.value,
            conversationSummary: conversationSummary
          })
        });
        
        // Hide thinking indicator
        hideThinking();
        
        if (!response.ok) {
          throw new Error(`HTTP error ${response.status}`);
        }
        
        const data = await response.json();
        
        // Add bot message to chat
        addMessage('bot', data.answer.text);
        
        // Display citations if present
        if (data.answer.citations && data.answer.citations.length > 0) {
          displayCitations(data.answer.citations);
        }
        
        // Show follow-up questions
        if (data.followUpQuestions && data.followUpQuestions.length > 0) {
          displayFollowUpQuestions(data.followUpQuestions);
        }
        
        // Update conversation history
        conversationHistory.push({ role: 'user', content: text });
        conversationHistory.push({ role: 'assistant', content: data.answer.text });
        
        // Trim history if needed (keep only last 6 messages / 3 exchanges)
        if (conversationHistory.length > 6) {
          conversationHistory = conversationHistory.slice(-6);
        }
        
        // Update conversation summary if provided
        if (data.conversationSummary) {
          conversationSummary = data.conversationSummary;
        }
        
      } catch (error) {
        hideThinking();
        console.error('Error:', error);
        addMessage('system', 'Error: Could not get a response. Please try again.');
      }
      
      // Re-enable input
      messageInput.disabled = false;
      sendBtn.disabled = false;
      messageInput.focus();
    }
    
    // Display citations
    function displayCitations(citations) {
      const citationsDiv = document.createElement('div');
      citationsDiv.className = 'citation';
      
      const citationsList = citations.map(citation => 
        `[${citation.id}] ${citation.text} (${citation.location || 'Unknown location'})`
      ).join('<br>');
      
      citationsDiv.innerHTML = `<strong>Sources:</strong><br>${citationsList}`;
      chat.lastChild.appendChild(citationsDiv);
    }
    
    // Display follow-up questions
    function displayFollowUpQuestions(questions) {
      const suggestionsDiv = document.createElement('div');
      suggestionsDiv.className = 'suggestions';
      
      questions.forEach(question => {
        const btn = document.createElement('button');
        btn.textContent = question;
        btn.onclick = () => {
          messageInput.value = question;
          sendMessage();
        };
        suggestionsDiv.appendChild(btn);
      });
      
      chat.appendChild(suggestionsDiv);
      chat.scrollTop = chat.scrollHeight;
    }
    
    // Add message to chat
    function addMessage(role, text) {
      const msg = document.createElement('div');
      msg.className = role;
      
      if (role === 'user') {
        msg.textContent = `You: ${text}`;
      } else if (role === 'bot') {
        msg.textContent = text;
      } else {
        msg.textContent = text;
      }
      
      chat.appendChild(msg);
      chat.scrollTop = chat.scrollHeight;
    }
    
    // Show thinking indicator
    function showThinking() {
      thinkingIndicator = document.createElement('div');
      thinkingIndicator.className = 'thinking';
      thinkingIndicator.innerHTML = 'Thinking <div class="dots"><span></span><span></span><span></span></div>';
      chat.appendChild(thinkingIndicator);
      chat.scrollTop = chat.scrollHeight;
    }
    
    // Hide thinking indicator
    function hideThinking() {
      if (thinkingIndicator && thinkingIndicator.parentNode === chat) {
        chat.removeChild(thinkingIndicator);
      }
    }
    
    // Clear chat history
    function clearChat() {
      // Keep only the first welcome message
      while (chat.childNodes.length > 1) {
        chat.removeChild(chat.lastChild);
      }
      
      // Reset state
      conversationHistory = [];
      conversationSummary = '';
      
      // Add system message
      addMessage('system', 'Chat history cleared');
    }
  </script>
</body>
</html> 